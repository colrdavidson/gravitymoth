<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no">
		<meta name="theme-color" content="#0083B7">

		<meta property="og:type"  content="article" /><meta property="og:url" content="https://gravitymoth.com/blog/dnsdecode" /><meta property="og:description" content="Breaking down the process of decoding DNS domain names" /><meta property="og:title" content="Gravity Moth - DNS Domain Name Decoding" /><meta property="twitter:title" content="Gravity Moth - DNS Domain Name Decoding" /><meta property="og:image" content="https://gravitymoth.com/media/logo_bg.png" /><meta property="og:locale" content="en_US"><meta property="og:site_name" content="Gravity Moth"><meta property="twitter:card" content="summary">

		<link rel="stylesheet" href="../style.css" />
		<link rel="shortcut icon" type="image/png" href="../media/favicon.png">
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Fira+Sans&family=Fira+Code&family=Montserrat&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed for GravityMoth Blog" href="https://gravitymoth.com/blog/feed.xml" />

		<script src="../index.js"></script>

		<title>Gravity Moth</title>
	</head>
	<body>
		<nav>
			<span class="nav-frame">
				<a class="nav-link top"       href="/">Gravity Moth</a>
				<button class="nav-link menu" onClick="toggleMenu();">
					<i class="fa fa-bars" aria-hidden="true"></i>
				</button>
				<a class="nav-link entry"     href="/blog">Blog</a>
			</span>
		</nav>
		<div id="dropdown-menu">
			<a class="dropdown entry" href="/blog">Blog</a>
		</div>
		<div class="root">
			<section id="header"><h1>DNS Domain Name Decoding</h1><h5>Fri, 18 Feb 2022</h5><div class="link-row"><a class="newer-link" href="dataviz.html"><i class="fa fa-arrow-left"></i>Newer</a><a class="older-link" href="dwarfsections.html">Older<i class="fa fa-arrow-right"/></i></a></div></section>
			<section id="content"><p>As part of my recent work on <code>core:net</code> for <a href="https://odin-lang.org">Odin</a>, I&rsquo;ve spent a chunk of time digging through a mountain of RFCs
to get DNS domain name decoding and encoding working.</p>

<p>So, terms here are goofy, but important.
A hostname is typically the name of a particular machine (ex: <code>mycomputer</code>), whereas a domain name is the name for the domain generally (ex: <code>gravitymoth.com</code>), and a FQDN (Fully Qualified Domain Name) is typically the hostname + the domain name (ex: <code>mycomputer.gravitymoth.com</code>).</p>

<p>Decoding is fairly simple (assuming you ignore newer unicode extensions).
To keep DNS packet sizes small, FQDNs get compressed using a technique similar to RLE (run-length encoding), with a little bit of
extra magic to allow label pasting.
Segments separated by <code>.</code> are referred to as &ldquo;labels&rdquo;. A label, represented as <code>&lt;length&gt;&lt;data&gt;</code>, is a maximum of
63 bytes long. FQDNs are a max of 255 bytes. Keep in mind while writing your DNS code, DNS packet data is big-endian.</p>

<p>Thinking about the hostname decoder as a bytecode interpreter, it supports 3 types of operations:</p>

<ul>
<li><code>&lt;length&gt;&lt;data&gt;</code></li>
<li><code>0xC0&lt;offset&gt;</code></li>
<li><code>0</code></li>
</ul>

<p><code>&lt;length&gt;&lt;data&gt;</code> (ex: <code>6google</code>) is easy, you read the length, and then add <code>length</code> number of characters
after it, plus a <code>.</code> to your result</p>

<p>For <code>0xC0&lt;offset&gt;</code>, you jump to the offset, indexed from the start of the packet (<code>0</code> is <code>packet[0]</code>)
and then read your next op</p>

<p><code>0</code> is terminal. When you hit it, you&rsquo;ve decoded the full FQDN</p>

<p>Decoding looks <em>roughly</em> like this</p>

<pre><code>def decode_name(packet, start_idx):
	name = &quot;&quot;
	cur_idx = start_idx
	labels_added = 0

	while True:
		match packet[cur_idx]:
			# We're at the end of the FQDN
			case 0:
				return name

			# Jump through the offset to more data in the packet
			case 0xC0:
				# The offset is 16bit, big endian
				cur_idx = u16be(packet[cur_idx:cur_idx+2])

			# This is a label, insert it into the name
			case _:
				if labels_added &gt; 0:
					name += &quot;.&quot;
				labels_added += 1

				label_size = int(packet[cur_idx])
				cur_idx += 1

				name += packet[cur_idx:cur_idx+label_size]
				cur_idx += label_size

	return name
</code></pre>
</section>
			<section id="sidebar">
				<ul><a class="slug-entry" href="dataviz.html"><li><p>Inspecting Data With Your Eyes</p></li></a><a class="slug-entry selected"><li><p>DNS Domain Name Decoding</p></li></a><a class="slug-entry" href="dwarfsections.html"><li><p>DWARF Section Breakdown</p></li></a><a class="slug-entry" href="firstentry.html"><li><p>Starting a Blog</p></li></a></ul>
			</section>
			<section id="nav-footer" class="link-row"><a class="newer-link" href="dataviz.html"><i class="fa fa-arrow-left"></i>Newer</a><a class="older-link" href="dwarfsections.html">Older<i class="fa fa-arrow-right"/></i></a></section>
		</div>
	</body>
</html>
